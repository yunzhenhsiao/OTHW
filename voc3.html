<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>單元三 - 單字學習</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .vocab-box {
      font-size: 1.8rem;
      padding: 20px;
      margin: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #ffffff;
      cursor: pointer;
      text-align: center;
      transition: background-color 0.2s;
    }
    .vocab-box:hover {
      background-color: #f0f8ff;
    }
    .avatar {
      width: 40px;
      height: 40px;
      object-fit: cover;
    }
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1050;
    }
    .modal-content {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      position: relative;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 2rem;
      cursor: pointer;
    }
    .popup-word {
      font-size: 3rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    .popup-roman {
      font-size: 1.5rem;
      color: #666;
      margin-bottom: 15px;
    }
    .popup-meaning {
      font-size: 1.8rem;
      color: #007bff;
      margin-bottom: 20px;
    }
    .navigation-buttons button {
      margin: 0 10px;
    }
    /* 新增已學習字卡的樣式 */
    .vocab-box.learned {
      background-color: #d4edda; /* 淺綠色，表示已學習 */
      border-color: #28a745;
    }
  </style>
</head>
<body class="bg-light">

  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4">
    <a class="navbar-brand" href="fp.html">回首頁</a>

    <div class="dropdown ms-3">
      <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
        單字測驗
      </a>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#">單元一測驗</a></li>
        <li><a class="dropdown-item" href="#">單元二測驗</a></li>
        <li><a class="dropdown-item" href="#">單元三測驗</a></li>
        <li><a class="dropdown-item" href="#">單元四測驗</a></li>
        <li><a class="dropdown-item" href="#">單元五測驗</a></li>
      </ul>
    </div>

    <div class="dropdown ms-auto" id="accountDropdown">
      <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" id="userEmailDisplay">
        <img src="https://via.placeholder.com/40" class="avatar" alt="User">
      </a>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="v1t.html">單字一測驗</a></li>
        <li><a class="dropdown-item" href="v2t.html">單字二測驗</a></li>
        <li><a class="dropdown-item" href="v3t.html">單字三測驗</a></li>
        <li><a class="dropdown-item" href="v4t.html">單字四測驗</a></li>
        <li><a class="dropdown-item" href="v5t.html">單字五測驗</a></li>
        </ul>
    </div>
  </nav>

  <div class="container text-center mt-5">
    <h2 class="mb-4">單字學習 - 單元三</h2>

    <div class="row justify-content-center" id="vocabCardContainer">
      </div>
  </div>

  <div class="modal-overlay" id="popupOverlay">
    <div class="modal-content">
      <span class="close-btn" onclick="closePopup(event)">&times;</span>
      <p id="popupWord" class="popup-word"></p>
      <p id="popupRoman" class="popup-roman"></p>
      <p id="popupMeaning" class="popup-meaning"></p>
      <div class="navigation-buttons">
        <button class="btn btn-secondary" onclick="prevCard(event)">上一張</button>
        <button class="btn btn-secondary" onclick="nextCard(event)">下一張</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module" src="./navbar-auth-status.js"></script>

  <script type="module">
    import { observeUser, getUserData, updateUserCardProgress } from './firebase-auth-utils.js';

    const UNIT_NAME = "單字三"; // <-- **重要**：這是該單元的名稱，用於 Firestore
    let currentUser = null; // 用於儲存當前登入的用戶
    let learnedCards = new Set(); // 用於儲存已學習的卡片索引

    const vocab = [
      { word: "감", roman: "gam", meaning: "柿子" },
      { word: "귤", roman: "gyul", meaning: "橘子" },
      { word: "딸기", roman: "ttalgi", meaning: "草莓" },
      { word: "바나나", roman: "banana", meaning: "香蕉" },
      { word: "사과", roman: "sagwa", meaning: "蘋果" },
      { word: "포도", roman: "podo", meaning: "葡萄" },
      { word: "오렌지", roman: "orenji", meaning: "柳丁" },
      { word: "수박", roman: "subak", meaning: "西瓜" },
      { word: "배", roman: "bae", meaning: "水梨" },
      { word: "복숭아", roman: "boksunga", meaning: "桃子" },
      { word: "멜론", roman: "mellon", meaning: "哈密瓜" },
      { word: "체리", roman: "cheri", meaning: "櫻桃" },
      { word: "망고", roman: "manggo", meaning: "芒果" },
      { word: "애호박", roman: "aehobak", meaning: "櫛瓜" },
      { word: "양파", roman: "yangpa", meaning: "洋蔥" },
      { word: "대파", roman: "daepa", meaning: "蔥" },
      { word: "고추", roman: "gochu", meaning: "辣椒" },
      { word: "감자", roman: "gamja", meaning: "馬鈴薯" },
      { word: "고구마", roman: "goguma", meaning: "地瓜" },
      { word: "당근", roman: "danggeun", meaning: "紅蘿蔔" },
      { word: "마늘", roman: "maneul", meaning: "蒜頭" },
      { word: "무", roman: "mu", meaning: "白蘿蔔" },
      { word: "오이", roman: "oi", meaning: "小黃瓜" },
      { word: "양배추", roman: "yangbaechu", meaning: "高麗菜" },
      { word: "배추", roman: "baechu", meaning: "大白菜" },
      { word: "버섯", roman: "beoseot", meaning: "香菇" },
      { word: "토마토", roman: "tomato", meaning: "番茄" },
      { word: "시금치", roman: "sigeumchi", meaning: "菠菜" },
      { word: "숙주", roman: "sukju", meaning: "豆芽菜" },
      { word: "떡볶이", roman: "tteokbokki", meaning: "辣炒年糕" },
      { word: "김치찌개", roman: "gimchijjigae", meaning: "泡菜鍋" },
      { word: "된장찌개", roman: "doenjangjjigae", meaning: "大醬湯" },
      { word: "순두부찌개", roman: "sundubujjigae", meaning: "嫩豆腐湯" },
      { word: "부대찌개", roman: "budaessigae", meaning: "部隊鍋" },
      { word: "김밥", roman: "gimbap", meaning: "紫菜包飯" },
      { word: "라면", roman: "ramyeon", meaning: "泡麵" },
      { word: "국밥", roman: "gukbap", meaning: "湯泡飯" },
      { word: "해물전", roman: "haemuljeon", meaning: "海鮮煎餅" },
      { word: "김치전", roman: "gimchijeon", meaning: "泡菜煎餅" },
      { word: "물냉면", roman: "mullaengmyeon", meaning: "水冷麵" },
      // 之後可加入更多單字
    ];
    const TOTAL_CARDS = vocab.length; // 總字卡數

    // 確保正確獲取 vocabCardContainer
    const vocabCardContainer = document.getElementById("vocabCardContainer"); 

    // 渲染或重新渲染單字卡
    function renderVocabCards() {
      if (!vocabCardContainer) { // 檢查元素是否存在
          console.error("vocabCardContainer not found!");
          return;
      }
      vocabCardContainer.innerHTML = ''; // 清空現有卡片
      vocab.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "col-md-3 col-sm-4 col-6 vocab-box"; // 調整網格大小
        if (learnedCards.has(index)) {
          div.classList.add("learned"); // 如果已學習，添加 learned class
        }
        div.textContent = item.word;
        div.onclick = () => openPopup(index); // 點擊時呼叫 openPopup
        vocabCardContainer.appendChild(div);
      });
    }

    // 點擊單字卡時，彈出視窗並記錄學習進度
    let currentIndex = 0; // 將 currentIndex 移到全局範圍
    // 將函數暴露給全局 window 物件，以便 HTML 中的 onclick 屬性可以調用它們
    window.openPopup = async (index) => { 
      currentIndex = index;
      const item = vocab[index];
      document.getElementById("popupWord").textContent = item.word;
      document.getElementById("popupRoman").textContent = item.roman;
      document.getElementById("popupMeaning").textContent = item.meaning;
      document.getElementById("popupOverlay").style.display = "flex";

      // 如果用戶已登入，記錄該字卡為已學習
      if (currentUser) {
        // 只有在未學習過這張卡片時才更新 Firestore
        if (!learnedCards.has(index)) {
          learnedCards.add(index); // 將該卡片索引加入已學習集合
          // 更新 UI
          const vocabBox = vocabCardContainer.children[index];
          if (vocabBox) {
            vocabBox.classList.add("learned");
          }
          // 更新 Firestore
          try {
            await updateUserCardProgress(currentUser.uid, UNIT_NAME, index, TOTAL_CARDS);
            console.log(`單字 ${UNIT_NAME} 的索引 ${index} 已標記為已學習。`);
          } catch (error) {
            console.error("更新單字卡進度失敗:", error);
          }
        }
      }
    };

    window.closePopup = (e) => { 
      // 確保只有點擊背景或關閉按鈕時才關閉彈窗
      if (e.target.id === "popupOverlay" || e.target.classList.contains("close-btn")) {
        document.getElementById("popupOverlay").style.display = "none";
      }
    };

    window.prevCard = (e) => { 
      e.stopPropagation(); // 阻止事件冒泡到背景，避免彈窗關閉
      currentIndex = (currentIndex - 1 + vocab.length) % vocab.length;
      openPopup(currentIndex);
    };

    window.nextCard = (e) => { 
      e.stopPropagation(); // 阻止事件冒泡到背景，避免彈窗關閉
      currentIndex = (currentIndex + 1) % vocab.length;
      openPopup(currentIndex);
    };

    // 在 DOMContentLoaded 事件監聽器中執行主邏輯
    document.addEventListener('DOMContentLoaded', () => {
      // 監聽用戶登入狀態
      observeUser(async (user) => {
        currentUser = user; // 儲存當前用戶

        if (user) {
          // 如果用戶已登入，載入其學習進度
          const userData = await getUserData(user.uid);
          if (userData && userData.learnedCards && userData.learnedCards[UNIT_NAME]) {
            learnedCards = new Set(userData.learnedCards[UNIT_NAME]);
          }
        } else {
          // 如果用戶登出，清空學習進度顯示
          learnedCards.clear();
        }
        renderVocabCards(); // 根據最新的學習進度重新渲染卡片
      });
    });

    // 鍵盤事件監聽器 (移到 DOMContentLoaded 之外，確保全局可用)
    document.addEventListener("keydown", (e) => {
      if (document.getElementById("popupOverlay").style.display === "flex") {
        if (e.key === "ArrowLeft") {
          prevCard(e);
        } else if (e.key === "ArrowRight") {
          nextCard(e);
        } else if (e.key === "Escape") {
          closePopup({ target: document.getElementById("popupOverlay") });
        }
      }
    });

  </script>
</body>
</html>