<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>單元一 - 單字學習</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .vocab-box {
      font-size: 1.8rem;
      padding: 20px;
      margin: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #ffffff;
      cursor: pointer;
      text-align: center;
      transition: background-color 0.2s;
    }
    .vocab-box:hover {
      background-color: #f0f8ff;
    }
    .avatar {
      width: 40px;
      height: 40px;
      object-fit: cover;
    }
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1050;
    }
    .modal-content {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      position: relative;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 2rem;
      cursor: pointer;
    }
    .popup-word {
      font-size: 3rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    .popup-roman {
      font-size: 1.5rem;
      color: #666;
      margin-bottom: 15px;
    }
    .popup-meaning {
      font-size: 1.8rem;
      color: #007bff;
      margin-bottom: 20px;
    }
    .navigation-buttons button {
      margin: 0 10px;
    }
    /* 新增已學習字卡的樣式 */
    .vocab-box.learned {
      background-color: #d4edda; /* 淺綠色，表示已學習 */
      border-color: #28a745;
    }
  </style>
</head>
<body class="bg-light">

  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4">
    <a class="navbar-brand" href="fp.html">回首頁</a>

    <div class="dropdown ms-3">
      <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
        單字測驗
      </a>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="v1t.html">單字一測驗</a></li>
        <li><a class="dropdown-item" href="v2t.html">單字二測驗</a></li>
        <li><a class="dropdown-item" href="v3t.html">單字三測驗</a></li>
        <li><a class="dropdown-item" href="v4t.html">單字四測驗</a></li>
        <li><a class="dropdown-item" href="v5t.html">單字五測驗</a></li>
        </ul>
    </div>

    <div class="dropdown ms-auto" id="accountDropdown">
      <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" id="userEmailDisplay">
        <img src="https://via.placeholder.com/40" class="avatar" alt="User">
      </a>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><span class="dropdown-item-text" id="accountEmail">尚未登入</span></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item text-primary" href="account.html">帳號狀態</a></li>
        <li><a class="dropdown-item text-danger" href="#" id="logoutBtn" style="display: none;">登出</a></li>
        <li><a class="dropdown-item" href="login.html" id="loginLink">登入 / 註冊</a></li>
      </ul>
    </div>
  </nav>

  <div class="container text-center mt-5">
    <h2 class="mb-4">單字學習 - 單元一</h2>

    <div class="row justify-content-center" id="vocabCardContainer">
      </div>
  </div>

  <div class="modal-overlay" id="popupOverlay">
    <div class="modal-content">
      <span class="close-btn" onclick="closePopup(event)">&times;</span>
      <p id="popupWord" class="popup-word"></p>
      <p id="popupRoman" class="popup-roman"></p>
      <p id="popupMeaning" class="popup-meaning"></p>
      <div class="navigation-buttons">
        <button class="btn btn-secondary" onclick="prevCard(event)">上一張</button>
        <button class="btn btn-secondary" onclick="nextCard(event)">下一張</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module" src="./navbar-auth-status.js"></script>

  <script type="module">
    import { observeUser, getUserData, updateUserCardProgress } from './firebase-auth-utils.js';

    const UNIT_NAME = "單字一"; // <-- **重要**：這是該單元的名稱，用於 Firestore
    let currentUser = null; // 用於儲存當前登入的用戶
    let learnedCards = new Set(); // 用於儲存已學習的卡片索引

    const vocab = [
      { word: "안녕하세요", roman: "annyeonghaseyo", meaning: "您好" },
      { word: "만나서 반가워요", roman: "mannaseo bangawoyo", meaning: "很高興認識您" },
      { word: "잘 부탁드려요", roman: "jal butakdeuryeoyo", meaning: "請多多指教" },
      { word: "안녕히 가세요", roman: "annyeonghi gaseyo", meaning: "請慢走" },
      { word: "안녕히 계세요", roman: "annyeonghi gyeseyo", meaning: "請留步" },
      { word: "감사합니다", roman: "gamsahamnida", meaning: "謝謝（偏正式）" },
      { word: "고마워요", roman: "gomawoyo", meaning: "謝謝（偏口語）" },
      { word: "잘 자요", roman: "jal jayo", meaning: "晚安" },
      { word: "안녕히 주무세요", roman: "annyeonghi jumuseyo", meaning: "晚安（對長輩）" },
      { word: "가수", roman: "gasu", meaning: "歌手" },
      { word: "간호사", roman: "ganhosa", meaning: "護理人員" },
      { word: "경찰", roman: "gyeongchal", meaning: "警察" },
      { word: "군인", roman: "gunin", meaning: "軍人" },
      { word: "운전기사", roman: "unjeongisa", meaning: "司機" },
      { word: "기자", roman: "gija", meaning: "記者" },
      { word: "모델", roman: "model", meaning: "模特" },
      { word: "변호사", roman: "byeonhosa", meaning: "律師" },
      { word: "학생", roman: "haksaeng", meaning: "學生" },
      { word: "배우", roman: "baeu", meaning: "演員" },
      { word: "운동선수", roman: "undongseonsu", meaning: "運動選手" },
      { word: "회사원", roman: "hoesawon", meaning: "上班族" },
      { word: "요리사", roman: "yorisa", meaning: "廚師" },
      { word: "은행원", roman: "eunhaengwon", meaning: "銀行員" },
      { word: "사진작가", roman: "sajinjjakga", meaning: "攝影師" },
      { word: "주부", roman: "jubu", meaning: "家庭主婦" },
      { word: "집", roman: "jip", meaning: "家" },
      { word: "방", roman: "bang", meaning: "房間" },
      { word: "시장", roman: "sijang", meaning: "市場" },
      { word: "식당", roman: "sikdang", meaning: "餐廳" },
      { word: "카페/커피숍", roman: "kape/keopisyop", meaning: "咖啡廳" },
      { word: "슈퍼마켓", roman: "syupeomaket", meaning: "超級市場" },
      { word: "노래방", roman: "noraebang", meaning: "KTV" },
      { word: "은행", roman: "eunhaeng", meaning: "銀行" },
      { word: "경찰서", roman: "gyeongchalseo", meaning: "警察局" },
      { word: "우체국", roman: "ucheguk", meaning: "郵局" },
      { word: "세탁소", roman: "setakso", meaning: "洗衣店" },
      { word: "공원", roman: "gongwon", meaning: "公園" },
      { word: "회사", roman: "hoesa", meaning: "公司" },
      { word: "사무실", roman: "samusil", meaning: "辦公室" },
      { word: "교실", roman: "gyosil", meaning: "教室" },
      // 之後可加入更多單字
    ];
    const TOTAL_CARDS = vocab.length; // 總字卡數

    // 確保正確獲取 vocabCardContainer
    const vocabCardContainer = document.getElementById("vocabCardContainer"); 

    // 渲染或重新渲染單字卡
    function renderVocabCards() {
      if (!vocabCardContainer) { // 檢查元素是否存在
          console.error("vocabCardContainer not found!");
          return;
      }
      vocabCardContainer.innerHTML = ''; // 清空現有卡片
      vocab.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "col-md-3 col-sm-4 col-6 vocab-box"; // 調整網格大小
        if (learnedCards.has(index)) {
          div.classList.add("learned"); // 如果已學習，添加 learned class
        }
        div.textContent = item.word;
        div.onclick = () => openPopup(index); // 點擊時呼叫 openPopup
        vocabCardContainer.appendChild(div);
      });
    }

    // 點擊單字卡時，彈出視窗並記錄學習進度
    let currentIndex = 0; // 將 currentIndex 移到全局範圍
    // 將函數暴露給全局 window 物件，以便 HTML 中的 onclick 屬性可以調用它們
    window.openPopup = async (index) => { 
      currentIndex = index;
      const item = vocab[index];
      document.getElementById("popupWord").textContent = item.word;
      document.getElementById("popupRoman").textContent = item.roman;
      document.getElementById("popupMeaning").textContent = item.meaning;
      document.getElementById("popupOverlay").style.display = "flex";

      // 如果用戶已登入，記錄該字卡為已學習
      if (currentUser) {
        // 只有在未學習過這張卡片時才更新 Firestore
        if (!learnedCards.has(index)) {
          learnedCards.add(index); // 將該卡片索引加入已學習集合
          // 更新 UI
          const vocabBox = vocabCardContainer.children[index];
          if (vocabBox) {
            vocabBox.classList.add("learned");
          }
          // 更新 Firestore
          try {
            await updateUserCardProgress(currentUser.uid, UNIT_NAME, index, TOTAL_CARDS);
            console.log(`單字 ${UNIT_NAME} 的索引 ${index} 已標記為已學習。`);
          } catch (error) {
            console.error("更新單字卡進度失敗:", error);
          }
        }
      }
    };

    window.closePopup = (e) => { 
      // 確保只有點擊背景或關閉按鈕時才關閉彈窗
      if (e.target.id === "popupOverlay" || e.target.classList.contains("close-btn")) {
        document.getElementById("popupOverlay").style.display = "none";
      }
    };

    window.prevCard = (e) => { 
      e.stopPropagation(); // 阻止事件冒泡到背景，避免彈窗關閉
      currentIndex = (currentIndex - 1 + vocab.length) % vocab.length;
      openPopup(currentIndex);
    };

    window.nextCard = (e) => { 
      e.stopPropagation(); // 阻止事件冒泡到背景，避免彈窗關閉
      currentIndex = (currentIndex + 1) % vocab.length;
      openPopup(currentIndex);
    };

    // 在 DOMContentLoaded 事件監聽器中執行主邏輯
    document.addEventListener('DOMContentLoaded', () => {
      // 監聽用戶登入狀態
      observeUser(async (user) => {
        currentUser = user; // 儲存當前用戶

        if (user) {
          // 如果用戶已登入，載入其學習進度
          const userData = await getUserData(user.uid);
          if (userData && userData.learnedCards && userData.learnedCards[UNIT_NAME]) {
            learnedCards = new Set(userData.learnedCards[UNIT_NAME]);
          }
        } else {
          // 如果用戶登出，清空學習進度顯示
          learnedCards.clear();
        }
        renderVocabCards(); // 根據最新的學習進度重新渲染卡片
      });
    });

    // 鍵盤事件監聽器 (移到 DOMContentLoaded 之外，確保全局可用)
    document.addEventListener("keydown", (e) => {
      if (document.getElementById("popupOverlay").style.display === "flex") {
        if (e.key === "ArrowLeft") {
          prevCard(e);
        } else if (e.key === "ArrowRight") {
          nextCard(e);
        } else if (e.key === "Escape") {
          closePopup({ target: document.getElementById("popupOverlay") });
        }
      }
    });

  </script>
</body>
</html>