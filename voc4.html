<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>單元四 - 單字學習</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .vocab-box {
      font-size: 1.8rem;
      padding: 20px;
      margin: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #ffffff;
      cursor: pointer;
      text-align: center;
      transition: background-color 0.2s;
    }
    .vocab-box:hover {
      background-color: #f0f8ff;
    }
    .avatar {
      width: 40px;
      height: 40px;
      object-fit: cover;
    }
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1050;
    }
    .modal-content {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      position: relative;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 2rem;
      cursor: pointer;
    }
    .popup-word {
      font-size: 3rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    .popup-roman {
      font-size: 1.5rem;
      color: #666;
      margin-bottom: 15px;
    }
    .popup-meaning {
      font-size: 1.8rem;
      color: #007bff;
      margin-bottom: 20px;
    }
    .navigation-buttons button {
      margin: 0 10px;
    }
    /* 新增已學習字卡的樣式 */
    .vocab-box.learned {
      background-color: #d4edda; /* 淺綠色，表示已學習 */
      border-color: #28a745;
    }
  </style>
</head>
<body class="bg-light">

  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4">
    <a class="navbar-brand" href="fp.html">回首頁</a>

    <div class="dropdown ms-3">
      <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
        單字測驗
      </a>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="v1t.html">單字一測驗</a></li>
        <li><a class="dropdown-item" href="v2t.html">單字二測驗</a></li>
        <li><a class="dropdown-item" href="v3t.html">單字三測驗</a></li>
        <li><a class="dropdown-item" href="v4t.html">單字四測驗</a></li>
        <li><a class="dropdown-item" href="v5t.html">單字五測驗</a></li>
        </ul>
    </div>

    <div class="dropdown ms-auto" id="accountDropdown">
      <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" id="userEmailDisplay">
        <img src="https://via.placeholder.com/40" class="avatar" alt="User">
      </a>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><span class="dropdown-item-text" id="accountEmail">尚未登入</span></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item text-primary" href="account.html">帳號狀態</a></li>
        <li><a class="dropdown-item text-danger" href="#" id="logoutBtn" style="display: none;">登出</a></li>
        <li><a class="dropdown-item" href="login.html" id="loginLink">登入 / 註冊</a></li>
      </ul>
    </div>
  </nav>

  <div class="container text-center mt-5">
    <h2 class="mb-4">單字學習 - 單元四</h2>

    <div class="row justify-content-center" id="vocabCardContainer">
      </div>
  </div>

  <div class="modal-overlay" id="popupOverlay">
    <div class="modal-content">
      <span class="close-btn" onclick="closePopup(event)">&times;</span>
      <p id="popupWord" class="popup-word"></p>
      <p id="popupRoman" class="popup-roman"></p>
      <p id="popupMeaning" class="popup-meaning"></p>
      <div class="navigation-buttons">
        <button class="btn btn-secondary" onclick="prevCard(event)">上一張</button>
        <button class="btn btn-secondary" onclick="nextCard(event)">下一張</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module" src="./navbar-auth-status.js"></script>

  <script type="module">
    import { observeUser, getUserData, updateUserCardProgress } from './firebase-auth-utils.js';

    const UNIT_NAME = "單字四"; // <-- **重要**：這是該單元的名稱，用於 Firestore
    let currentUser = null; // 用於儲存當前登入的用戶
    let learnedCards = new Set(); // 用於儲存已學習的卡片索引

    const vocab = [
      { word: "비빔냉면", roman: "bibimnaengmyeon", meaning: "拌冷麵" },
      { word: "떡국", roman: "tteokguk", meaning: "年糕湯" },
      { word: "삼계탕", roman: "samgyetang", meaning: "蔘雞湯" },
      { word: "설렁탕", roman: "seolleongtang", meaning: "雪濃湯" },
      { word: "만두", roman: "mandu", meaning: "餃子" },
      { word: "자장면", roman: "jajangmyeon", meaning: "炸醬麵" },
      { word: "짬뽕", roman: "jjamppong", meaning: "炒碼麵" },
      { word: "탕수육", roman: "tangsuyuk", meaning: "糖醋肉" },
      { word: "불고기", roman: "bulgogi", meaning: "烤牛肉" },
      { word: "삼겹살", roman: "samgyeopsal", meaning: "五花肉" },
      { word: "비빔밥", roman: "bibimbap", meaning: "拌飯" },
      { word: "산낙지", roman: "sannakji", meaning: "活章魚" },
      { word: "볶음밥", roman: "bokkeumbap", meaning: "炒飯" },
      { word: "닭갈비", roman: "dakgalbi", meaning: "辣炒雞" },
      { word: "치킨", roman: "chikin", meaning: "炸雞" },
      { word: "아메리카노", roman: "amerikano", meaning: "美式咖啡" },
      { word: "카페라떼", roman: "kape latte", meaning: "拿鐵" },
      { word: "카푸치노", roman: "kapuchino", meaning: "卡布奇諾" },
      { word: "녹차", roman: "nokcha", meaning: "綠茶" },
      { word: "홍차", roman: "hongcha", meaning: "紅茶" },
      { word: "밀크티", roman: "milkeuti", meaning: "奶茶" },
      { word: "주스", roman: "juseu", meaning: "果汁" },
      { word: "아이스크림", roman: "aiseukeurim", meaning: "冰淇淋" },
      { word: "케이크", roman: "keikeu", meaning: "蛋糕" },
      { word: "콜라", roman: "kolla", meaning: "可樂" },
      { word: "우유", roman: "uyu", meaning: "牛奶" },
      { word: "빵", roman: "ppang", meaning: "麵包" },
      { word: "샌드위치", roman: "saendeuwichi", meaning: "三明治" },
      { word: "피자", roman: "pija", meaning: "披薩" },
      { word: "맥주", roman: "maekju", meaning: "啤酒" },
      { word: "과자", roman: "gwaja", meaning: "餅乾" },
      { word: "자동차", roman: "jadongcha", meaning: "車" },
      { word: "자전거", roman: "jajeongeo", meaning: "腳踏車" },
      { word: "비행기", roman: "bihaenggi", meaning: "飛機" },
      { word: "택시", roman: "taeksi", meaning: "計程車" },
      { word: "배", roman: "bae", meaning: "船" },
      { word: "버스", roman: "beoseu", meaning: "公車" },
      { word: "기차", roman: "gicha", meaning: "火車" },
      { word: "지하철", roman: "jihacheol", meaning: "捷運" },
      { word: "신호등", roman: "sinhodeung", meaning: "紅綠燈" },
      // 之後可加入更多單字
    ];
    const TOTAL_CARDS = vocab.length; // 總字卡數

    // 確保正確獲取 vocabCardContainer
    const vocabCardContainer = document.getElementById("vocabCardContainer"); 

    // 渲染或重新渲染單字卡
    function renderVocabCards() {
      if (!vocabCardContainer) { // 檢查元素是否存在
          console.error("vocabCardContainer not found!");
          return;
      }
      vocabCardContainer.innerHTML = ''; // 清空現有卡片
      vocab.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "col-md-3 col-sm-4 col-6 vocab-box"; // 調整網格大小
        if (learnedCards.has(index)) {
          div.classList.add("learned"); // 如果已學習，添加 learned class
        }
        div.textContent = item.word;
        div.onclick = () => openPopup(index); // 點擊時呼叫 openPopup
        vocabCardContainer.appendChild(div);
      });
    }

    // 點擊單字卡時，彈出視窗並記錄學習進度
    let currentIndex = 0; // 將 currentIndex 移到全局範圍
    // 將函數暴露給全局 window 物件，以便 HTML 中的 onclick 屬性可以調用它們
    window.openPopup = async (index) => { 
      currentIndex = index;
      const item = vocab[index];
      document.getElementById("popupWord").textContent = item.word;
      document.getElementById("popupRoman").textContent = item.roman;
      document.getElementById("popupMeaning").textContent = item.meaning;
      document.getElementById("popupOverlay").style.display = "flex";

      // 如果用戶已登入，記錄該字卡為已學習
      if (currentUser) {
        // 只有在未學習過這張卡片時才更新 Firestore
        if (!learnedCards.has(index)) {
          learnedCards.add(index); // 將該卡片索引加入已學習集合
          // 更新 UI
          const vocabBox = vocabCardContainer.children[index];
          if (vocabBox) {
            vocabBox.classList.add("learned");
          }
          // 更新 Firestore
          try {
            await updateUserCardProgress(currentUser.uid, UNIT_NAME, index, TOTAL_CARDS);
            console.log(`單字 ${UNIT_NAME} 的索引 ${index} 已標記為已學習。`);
          } catch (error) {
            console.error("更新單字卡進度失敗:", error);
          }
        }
      }
    };

    window.closePopup = (e) => { 
      // 確保只有點擊背景或關閉按鈕時才關閉彈窗
      if (e.target.id === "popupOverlay" || e.target.classList.contains("close-btn")) {
        document.getElementById("popupOverlay").style.display = "none";
      }
    };

    window.prevCard = (e) => { 
      e.stopPropagation(); // 阻止事件冒泡到背景，避免彈窗關閉
      currentIndex = (currentIndex - 1 + vocab.length) % vocab.length;
      openPopup(currentIndex);
    };

    window.nextCard = (e) => { 
      e.stopPropagation(); // 阻止事件冒泡到背景，避免彈窗關閉
      currentIndex = (currentIndex + 1) % vocab.length;
      openPopup(currentIndex);
    };

    // 在 DOMContentLoaded 事件監聽器中執行主邏輯
    document.addEventListener('DOMContentLoaded', () => {
      // 監聽用戶登入狀態
      observeUser(async (user) => {
        currentUser = user; // 儲存當前用戶

        if (user) {
          // 如果用戶已登入，載入其學習進度
          const userData = await getUserData(user.uid);
          if (userData && userData.learnedCards && userData.learnedCards[UNIT_NAME]) {
            learnedCards = new Set(userData.learnedCards[UNIT_NAME]);
          }
        } else {
          // 如果用戶登出，清空學習進度顯示
          learnedCards.clear();
        }
        renderVocabCards(); // 根據最新的學習進度重新渲染卡片
      });
    });

    // 鍵盤事件監聽器 (移到 DOMContentLoaded 之外，確保全局可用)
    document.addEventListener("keydown", (e) => {
      if (document.getElementById("popupOverlay").style.display === "flex") {
        if (e.key === "ArrowLeft") {
          prevCard(e);
        } else if (e.key === "ArrowRight") {
          nextCard(e);
        } else if (e.key === "Escape") {
          closePopup({ target: document.getElementById("popupOverlay") });
        }
      }
    });

  </script>
</body>
</html>